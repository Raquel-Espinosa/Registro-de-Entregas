<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Entregas - Auditor</title>
    
    <!-- 1. Estilos: Tailwind CSS (Diseño) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React y ReactDOM (Motor de la app) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- 3. Babel (Para entender el código moderno en el navegador) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. Iconos (FontAwesome para reemplazar Lucide) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- 5. Firebase (Base de datos - Versión Compat para HTML simple) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div id="root"></div>

    <script type="text/babel">
        // --- TU CONFIGURACIÓN DE FIREBASE AQUÍ ---
        // 1. Ve a console.firebase.google.com
        // 2. Crea un proyecto > Agrega App Web > Copia las claves
        // 3. Reemplaza los valores de abajo con TUS PROPIAS credenciales:
        const firebaseConfig = {
            apiKey: "AIzaSyCwdj9y03bp5cFfy587Dr2nFDMe7gZCYrw",
            authDomain: "control-entregas-app.firebaseapp.com",
            projectId: "control-entregas-app",
            storageBucket: "control-entregas-app.firebasestorage.app",
            messagingSenderId: "141381181216",
            appId: "1:141381181216:web:c81e66c926523a1fc50145"
        };

        // Inicializar Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- LISTA DE AUDITORES AUTORIZADOS ---
        // Aquí puedes agregar, borrar o editar usuarios.
        const AUDITORS_LIST = [
            { user: 'auditor', pass: '1234',   name: 'Auditor General' },
            { user: '97615', pass: 'Inicio.02',  name: 'Julio Hernandez' },
            { user: '97743', pass: 'Inicio.01', name: 'Jorge Miros' },
            { user: '99270', pass: 'Inicio.03', name: 'Lesli Sagnite' }
            { user: '54668', pass: 'Inicio.04', name: 'David Bautista' },
            { user: '99103', pass: 'Inicio.05', name: 'Luis Jimenez' }

        ];

        // --- COMPONENTES DE LA APP ---

        function App() {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('login'); 
            const [loading, setLoading] = React.useState(true);
            const [configError, setConfigError] = React.useState(null);
            const [currentAuditorName, setCurrentAuditorName] = React.useState('');

            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((currentUser) => {
                    setUser(currentUser);
                    setLoading(false);
                });
                
                // Intentar iniciar sesión anónima
                if (!user) {
                     auth.signInAnonymously().catch(e => {
                         console.error("Error de Auth:", e);
                         let msg = "Error desconocido de autenticación.";
                         
                         if (e.code === 'auth/configuration-not-found') {
                             msg = "Falta activar 'Authentication' en Firebase Console.";
                         } else if (e.code === 'auth/admin-restricted-operation' || e.code === 'auth/operation-not-allowed') {
                             msg = "El método de inicio de sesión 'Anónimo' no está habilitado en Firebase Console.";
                         } else {
                             msg = e.message;
                         }
                         setConfigError(msg);
                         setLoading(false);
                     });
                }
                return () => unsubscribe();
            }, []);

            const handleAuditorLogin = (name) => {
                setCurrentAuditorName(name);
                setView('dashboard');
            };

            const handleLogout = () => {
                setCurrentAuditorName('');
                setView('login');
            };

            if (configError) {
                return (
                    <div className="h-screen w-full flex flex-col items-center justify-center p-6 bg-red-50 text-center">
                        <div className="bg-white p-8 rounded-xl shadow-xl border border-red-200 max-w-md">
                            <i className="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
                            <h2 className="text-xl font-bold text-red-700 mb-2">Error de Configuración</h2>
                            <p className="text-gray-700 mb-4">{configError}</p>
                            <div className="text-left text-sm bg-gray-100 p-4 rounded text-gray-600">
                                <strong>Solución:</strong>
                                <ol className="list-decimal ml-4 mt-2 space-y-1">
                                    <li>Ve a <a href="https://console.firebase.google.com" target="_blank" className="text-blue-600 underline">Firebase Console</a>.</li>
                                    <li>Entra a tu proyecto.</li>
                                    <li>En el menú izquierdo, busca <strong>Compilación (Build)</strong> > <strong>Authentication</strong>.</li>
                                    <li>Dale a "Comenzar".</li>
                                    <li>En la pestaña "Sign-in method", activa <strong>Anónimo</strong>.</li>
                                </ol>
                            </div>
                            <button onClick={() => window.location.reload()} className="mt-6 w-full bg-red-600 text-white py-2 rounded hover:bg-red-700">Recargar Página</button>
                        </div>
                    </div>
                );
            }

            if (loading) return <div className="h-screen w-full flex items-center justify-center text-gray-500"><i className="fa-solid fa-spinner fa-spin mr-2"></i> Cargando sistema...</div>;

            return (
                <div className="min-h-screen">
                    {view === 'login' && <LoginScreen onLogin={handleAuditorLogin} />}
                    {view === 'dashboard' && <Dashboard user={user} auditorName={currentAuditorName} onLogout={handleLogout} onSettings={() => setView('settings')} />}
                    {view === 'settings' && <SettingsScreen onBack={() => setView('dashboard')} />}
                </div>
            );
        }

        function LoginScreen({ onLogin }) {
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [error, setError] = React.useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                // Buscar usuario en la lista
                const foundUser = AUDITORS_LIST.find(
                    u => u.user.toLowerCase() === username.toLowerCase().trim() && u.pass === password.trim()
                );

                if (foundUser) {
                    onLogin(foundUser.name);
                } else {
                    setError('Usuario o contraseña incorrectos.');
                }
            };

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-4 bg-gradient-to-br from-blue-900 to-slate-800">
                    <div className="w-full max-w-md bg-white rounded-xl shadow-2xl overflow-hidden">
                        <div className="bg-blue-600 p-6 text-center">
                            <i className="fa-solid fa-truck text-4xl text-white mb-2"></i>
                            <h1 className="text-2xl font-bold text-white">Control de Entregas</h1>
                        </div>
                        <form onSubmit={handleLogin} className="p-8 space-y-6">
                            {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded">{error}</div>}
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                                <input type="text" className="w-full p-2 border rounded" placeholder="ej. juan" value={username} onChange={(e) => setUsername(e.target.value)} />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input type="password" className="w-full p-2 border rounded" placeholder="****" value={password} onChange={(e) => setPassword(e.target.value)} />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded">Ingresar</button>
                            <div className="text-center text-xs text-gray-400 mt-2">
                                Usuarios activos: {AUDITORS_LIST.map(u => u.user).join(', ')}
                            </div>
                        </form>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, auditorName, onLogout, onSettings }) {
            const [pickerId, setPickerId] = React.useState('');
            const [deliveryId, setDeliveryId] = React.useState('');
            const [recentScans, setRecentScans] = React.useState([]);
            const [isPickerLocked, setIsPickerLocked] = React.useState(false);
            const [statusMsg, setStatusMsg] = React.useState({ type: '', text: '' });
            const [scriptUrl, setScriptUrl] = React.useState(localStorage.getItem('googleScriptUrl') || '');
            const deliveryInputRef = React.useRef(null);

            React.useEffect(() => {
                if (!user) return;
                // Escuchar cambios en Firestore
                const unsubscribe = db.collection('entregas')
                    .orderBy('timestamp', 'desc')
                    .limit(50)
                    .onSnapshot(snapshot => {
                        const data = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            timestamp: doc.data().timestamp ? doc.data().timestamp.toDate() : new Date()
                        }));
                        setRecentScans(data);
                    }, error => {
                        console.error("Error obteniendo datos:", error);
                        if (error.code === 'failed-precondition') {
                             setStatusMsg({ type: 'error', text: 'Falta índice en Firebase. Ordenando localmente...' });
                        }
                    });
                return () => unsubscribe();
            }, [user]);

            const handlePickerChange = (e) => {
                const val = e.target.value.replace(/\D/g, '');
                if (val.length <= 6) setPickerId(val);
            };

            const togglePickerLock = () => {
                if (!pickerId && !isPickerLocked) return;
                setIsPickerLocked(!isPickerLocked);
                if (!isPickerLocked) setTimeout(() => deliveryInputRef.current?.focus(), 100);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!pickerId || !deliveryId) return;

                // Usamos el nombre real del auditor logueado
                const currentAuditor = auditorName || 'Desconocido';

                const newEntry = {
                    pickerId,
                    deliveryId,
                    auditor: currentAuditor,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    dateString: new Date().toLocaleDateString(),
                    timeString: new Date().toLocaleTimeString()
                };

                try {
                    await db.collection('entregas').add(newEntry);
                    
                    if (scriptUrl) {
                        fetch(scriptUrl, {
                            method: 'POST',
                            mode: 'no-cors',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                picker: pickerId, 
                                entrega: deliveryId, 
                                auditor: currentAuditor 
                            })
                        }).catch(console.error);
                    }
                    setStatusMsg({ type: 'success', text: `Entrega ${deliveryId} OK` });
                    setDeliveryId('');
                    deliveryInputRef.current?.focus();
                } catch (err) {
                    console.error(err);
                    setStatusMsg({ type: 'error', text: 'Error al guardar. ¿Base de datos creada?' });
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-4">
                    <header className="flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow border">
                        <div className="flex items-center space-x-2">
                            <i className="fa-solid fa-user-circle text-2xl text-blue-600"></i>
                            <div>
                                <span className="font-bold text-slate-800 block leading-tight">{auditorName}</span>
                                <span className="text-xs text-slate-500">Sesión Activa</span>
                            </div>
                        </div>
                        <div>
                            <button onClick={onSettings} className="p-2 text-gray-400 hover:text-blue-600" title="Configuración"><i className="fa-solid fa-cog"></i></button>
                            <button onClick={onLogout} className="p-2 text-gray-400 hover:text-red-600" title="Cerrar Sesión"><i className="fa-solid fa-sign-out-alt"></i></button>
                        </div>
                    </header>

                    <div className="bg-white rounded-xl shadow border mb-6">
                         <div className="bg-slate-50 border-b p-4 flex justify-between">
                            <h3 className="font-bold text-slate-700"><i className="fa-solid fa-box mr-2"></i>Registro</h3>
                            {statusMsg.text && <span className={`text-xs px-2 py-1 rounded-full ${statusMsg.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{statusMsg.text}</span>}
                        </div>
                        <form onSubmit={handleSubmit} className="p-6 space-y-6">
                            <div>
                                <label className="block text-sm font-bold text-slate-600 mb-1">PICKER ID</label>
                                <div className="flex space-x-2">
                                    <input type="text" inputMode="numeric" value={pickerId} onChange={handlePickerChange} disabled={isPickerLocked} className="flex-1 bg-slate-50 border-2 p-3 rounded text-xl disabled:bg-gray-200" placeholder="123456" />
                                    <button type="button" onClick={togglePickerLock} className={`px-4 rounded font-bold ${isPickerLocked ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}`}>
                                        {isPickerLocked ? <i className="fa-solid fa-lock"></i> : <i className="fa-solid fa-lock-open"></i>}
                                    </button>
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-slate-600 mb-1">ENTREGA ID</label>
                                <input ref={deliveryInputRef} type="text" inputMode="numeric" value={deliveryId} onChange={(e) => setDeliveryId(e.target.value.replace(/\D/g, '').substring(0, 10))} className="w-full border-2 border-blue-500 p-4 rounded text-2xl" placeholder="Escanear..." autoFocus />
                            </div>
                            <button type="submit" className="w-full bg-blue-600 text-white font-bold py-4 rounded shadow hover:bg-blue-700">REGISTRAR</button>
                        </form>
                    </div>

                    <div className="space-y-3">
                         <h4 className="text-sm font-bold text-slate-500"><i className="fa-solid fa-history mr-2"></i>Historial Reciente</h4>
                         <div className="bg-white rounded shadow border max-h-96 overflow-y-auto divide-y">
                            {recentScans.map(scan => (
                                <div key={scan.id} className="p-4 flex justify-between">
                                    <div>
                                        <div className="font-bold text-lg">#{scan.deliveryId}</div>
                                        <div className="text-xs text-gray-500">Picker: {scan.pickerId} | <span className="text-blue-600">{scan.auditor}</span></div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-full">{scan.timeString}</div>
                                    </div>
                                </div>
                            ))}
                         </div>
                    </div>
                </div>
            );
        }

        function SettingsScreen({ onBack }) {
            const [url, setUrl] = React.useState(localStorage.getItem('googleScriptUrl') || '');
            const save = () => { localStorage.setItem('googleScriptUrl', url); onBack(); };
            return (
                <div className="max-w-2xl mx-auto p-4">
                    <div className="bg-white rounded shadow border p-6 space-y-4">
                        <h2 className="font-bold text-lg">Configurar Google Sheets</h2>
                        <input type="text" className="w-full border p-2 rounded" placeholder="URL del Web App Script" value={url} onChange={e => setUrl(e.target.value)} />
                        <div className="flex space-x-2">
                             <button onClick={onBack} className="flex-1 bg-gray-200 py-2 rounded">Cancelar</button>
                             <button onClick={save} className="flex-1 bg-green-600 text-white py-2 rounded">Guardar</button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

